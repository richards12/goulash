#FC=ftn
#CC=CC

FC=/usr/tce/packages/rocmcc-tce/rocmcc-5.2.3-cce-14.0.3/bin/crayftn
CC=/usr/tce/packages/rocmcc-tce/rocmcc-5.2.3-cce-14.0.3/bin/amdclang++

ROCM_PATH=/opt/rocm-5.2.3

CXX_FLAGS=-O3
HIP_FLAGS=-I${ROCM_PATH}/include -fgpu-rdc --rocm-path=${ROCM_PATH} --offload-arch=gfx90a -x hip
FORTRAN_FLAGS=-h omp -haccel=amd_gfx90a

LFLAGS=-fopenmp
HIP_LINK_FLAGS=-fopenmp -fgpu-rdc --hip-link --offload-arch=gfx90a --rocm-path=${ROCM_PATH} -L${ROCM_PATH}/lib -lamdhip64
CRAY_EXT_LINKING_FLAGS=-L${CRAYLIBS_X86_64} -lcrayacc_amdgpu -lcraymp -lf -lmodules -Wl,-rpath,${CRAYLIBS_X86_64}

runGhoul: main.o libhlib.a libflib.a 
	ROCM_PATH=${ROCM_PATH} /opt/cray/pe/cce/14.0.3/cce/x86_64/bin/cce_omp_offload_linker --arch gfx90a --device-link-only --output-begin=libf_begin.o --output-end=libf_end.o -- libflib.a
	$(CC) -o $@ $(HIP_LINK_FLAGS) libf_begin.o main.o -L. -lhlib -lflib libf_end.o ${CRAY_EXT_LINKING_FLAGS}

main.o: main.cpp
	$(CC) $(CXX_FLAGS) $(HIP_FLAGS) -o $@ -c $<

suskevi.o: suskevi.cpp
	$(CC) $(CXX_FLAGS) $(HIP_FLAGS) -o $@ -c $<

libhlib.a: suskevi.o
	ar rcs $@ $^

foo_mod.o: foo_mod.f90
	$(FC) $(FORTRAN_FLAGS) -o $@ -c $<

libflib.a: foo_mod.o
	ar rcs $@ $^

.PHONY: clean
clean:
	rm -rf *.o runGhoul *core FOO.mod foo_mod_1.acc.s libhlib.a libflib.a
